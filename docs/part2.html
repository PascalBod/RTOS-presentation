<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="icon" href="favicon.ico">

    <title>RTOS for ML</title>

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/pb.css">
    <link rel="stylesheet" href="pres-style.css">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css">
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
	
        <!-- -------------------- Contents ---------------------------------------- -->

        <section>
          <h3>Contents - 1/2</h3>
          <div class="pbcolumns">
            <div class="pbsmaller">
              <ul>
                <li><a href="#/executionEnvironments">Execution environments</a>
                  <ul>
                    <li><a href="#/bareMetal">Bare metal</a></li>
                    <li><a href="#/rtos">RTOS</a></li>
                    <li><a href="#/os">OS</a></li>
                  </ul>
                </li>
                <li><a href="#/moreAboutRtos">More about what an RTOS is</a></li>
                <li><a href="#/benefits">Benefits</a></li>
                <li><a href="#/drawbacks">Drawbacks</a></li>
                <li><a href="#/components">Components</a></li>
                <li><a href="#/tasks">Tasks</a>
                  <ul>
                    <li><a href="#/whatATaskIs">What a task is and can do</a></li>
                    <li><a href="#/exercise11"><b>Practice: creating and starting one task</b></a></li>
                  </ul>
                </li>
              </ul>
            </div>
            <div class="pbsmaller">
              <ul>
                <li><a href="#/concurrencyControl">Concurrency control</a>
                  <ul>
                    <li><a href="#/exercise12"><b>Practice: sharing data bug</b></a></li>
                    <li>Problem statement</li>
                    <li>Mutex</li>
                    <li><b>Practice: shared structure with mutex</b></li>
                    <li>Priority inversion</li>
                    <li>Deadlock</li>
                    <li>Semaphore</li>
                    <li><b>Practice: semaphore</b></li>
                  </ul>
                </li>
                <li>Communication
                  <ul>
                    <li>Introduction</li>
                    <li>Queues</li>
                    <li><b>Practice: using a queue</b></li>
                    <li><b>Practice: getting all button presses</b></li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h3>Contents - 2/2</h3>
          <div class="pbcolumns">
            <div class="pbsmaller">
              <ul>
                <li>Communication and concurrency control
                  <ul>
                    <li>Queues</li>
                    <li><b>Practice: preventing deadlocks</b></li>
                  </ul>
                </li>
                <li>Concurrency: summary</li>
                <li>Time</li>
                <li>Memory allocation</li>
                <li>Middleware</li>
                <li><b>Practice: a non-trivial application</b></li>
              </ul>
            </div>
          </div>
        </section>
        
        <!-- -------------------- Execution environments ---------------------------------------- -->
        
        <section id="executionEnvironments">
          <h3>Execution environments</h3>
        </section>
        <section>
          <p>Execution environment: what the target board provides to run an application.</p>
        </section>
        
        <!-- -------------------- Execution environments > bare metal ---------------------------------------- -->
        
        <section id="bareMetal">
          <h4>Bare metal</h4>
          <ul>
            <li>You write all the code, without any help to run concurrent tasks,
              to share data between tasks, etc.</li>
            <li>Nowadays, an abstraction layer is provided by almost all 
              microcontroller manufacturers:
              <ul>
                <li>&rArr; Compatibility over a family of microcontrollers</li>
                <li>&rArr; A little bit easier to use peripherals and interfaces</li>
                <li>Arm: <a href="https://www.arm.com/technologies/cmsis" target="_blank">CMSIS</a></li>
                <li>Silicon Labs: <a href="https://www.silabs.com/developer-tools/gecko-software-development-kit"
                      target="_blank"">Gecko SDK</a></li>
                <li>STMicroelectronics: <a href="https://github.com/STMicroelectronics/STM32Cube_MCU_Overall_Offer/blob/master/README.md#stm32cube-hal-drivers"
                      target="_blank">HAL + LL</a></li>
                <li>Espressif: <a href="https://www.espressif.com/en/products/sdks/esp-idf"
                      target="_blank">ESP-IDF</a></li>
                <li>Etc.</li>
              </ul>
            </li>
          </ul>
          <p>What we did in the practical sessions is bare-metal software development.</p>
        </section>
        
        <!-- -------------------- Execution environments > RTOS ---------------------------------------- -->

        <section id="rtos">
          <h4>Real-Time Operating System (RTOS)</h4>
          <ul>
            <li>Provides real help to run concurrent tasks, share data between tasks, etc.</li>
            <li>Allows for deterministic response time</li>
            <li>Uses very little memory</li>
            <li>No protection between tasks, nor between tasks and RTOS (no virtual memory)</li>
            <li>No way to modify the application without rebuilding and reflashing (well, not fully true)</li>
          </ul>
        </section>

        <section>
          <p>Minimum required memory:</p>
          <ul>
            <li>RAM: a few KB</li>
            <li>Flash: a few KB</li>
            <li>Depends on the application</li>
          </ul>
        </section>

        <section>
          <img src="images/rtos.png">
          <div class="pbverysmall">Sources: <a href="https://www.freertos.org/index.html" title="FreeRTOS"
                                               target="_blank">FreeRTOS</a>,
            <a href="https://www.ecoscentric.com/ecos/index.shtml" title="eCos" target="_blank">eCos</a>,
            <a href="https://www.contiki-ng.org/" title="Contiki-NG"
               target="_blank">Contiki-NG</a>,
            <a href="http://riot-os.org/" title="RIOT" target="_blank">RIOT</a>,
            <a href="https://blackberry.qnx.com/en" title="QNX" target="_blank">QNX</a>,
           <a href="https://www.rt-thread.io/index.html" title="RT-Thread" target="_blank">RT-Thread</a>,
            <a href="https://www.zephyrproject.org/" title="Zephyr" target="_blank">Zephyr</a>,
            <a href="https://threadx.io/" title="ThreadX"
               target="_blank">ThreadX</a>,
            <a href="https://www.silabs.com/developer-tools/micrium-os" title="Micriµm OS" target="_blank">Micriµm OS</a>,
            <a href="https://microware.com/" title="OS-9" target="_blank">OS-9</a>,
            <a href="https://mynewt.apache.org/" title="Mynewt" target="_blank">Mynewt</a>,
            <a href="https://www.windriver.com/products/vxworks/" title="VxWorks"
               target="_blank">VxWorks</a>,
            <a href="https://www.lynx.com/products/lynxos-posix-real-time-operating-system-rtos"
               title="LynxOS" target="_blank">LynxOS</a>,
            <a href="https://www.zerynth.com/zos/" title="Zerynth OS" target="_blank">Zerynth OS</a>,
            <a href="https://nuttx.apache.org/" title="NuttX" target="_blank">NuttX</a>
          </div>        
        </section>

        <section>
          <ul>
            <li>FreeRTOS acquired by Amazon - 2017</li>
            <li>ThreadX acquired by Microsoft - 2019, transferred to the Eclipse Foundation, as open source - 2023</li>
            <li>Google and Meta support Zephyr</li>
          </ul>
        </section>
        
        <section>
          <p>Available services: will be seen farther.</p>
        </section>

        <!-- -------------------- Execution environments > OS ---------------------------------------- -->

        <section id="os">
          <h4>Operating System (OS)</h4>
          <ul>
            <li>Mainly: Linux</li>
            <li>Similar to a desktop computer environment:
              <ul>
                <li>Package manager, to install new applications</li>
                <li>Graphical user interface is possible</li>
              </ul>
            </li>
          </ul>
        </section>

        <section>
          <p>Minimum required memory:</p>
          <ul>
            <li>RAM: a few MB or a few tens of MB</li>
            <li>Depends on applications</li>
          </ul>
          <p>Usually:</p>
          <ul>
            <li>RAM: from 512 MB to 8 GB</li>
            <li>Flash card: from 1 GB to 8 GB</li>
          </ul>
        </section>

        <section>
          <ul>
            <li>Linux typically requires an MMU (Memory Management Unit) &rArr; virtual memory</li>
            <li>The kernel can be configured to work without one
              <ul>
                <li>Thanks to μClinux project</li>
                <li>Beware about applications compatibility</li>
              </ul>
            </li>
          </ul>
        </section>

        <section>
          <img src="images/embeddedOS.png">
          <div class="pbverysmall">Sources: <a href="https://isc.tamu.edu/~lewing/linux/" title="Larry Ewing"
                                               target="_blank">Larry Ewing</a>,
            <a href="https://www.yoctoproject.org/" title="Yocto Project" target="_blank">Yocto Project</a>,
            <a href="https://legato.io/" title="Legato" target="_blank">Legato</a>,
            <a href="https://archlinuxarm.org/" title="Arch Linux ARM" target="_blank">Arch Linux ARM</a>,
            <a href="https://openwrt.org/" title="OpenWrt Project" target="_blank">OpenWrt Project</a>,
            <a href="https://www.balena.io/os/" title="balenaOS" target="_blank">balenaOS</a>,
            <a href="https://www.windriver.com/products/linux/" title="Wind River" target="_blank">Wind
              River</a>,
            <a href="https://www.mvista.com/" title="MontaVista" target="_blank">MontaVista</a>,
            <a href="https://www.lynx.com/products/lynx-mosaic-modular-development-framework"
               title="LYNX MOSA.ic" target="_blank">LYNX MOSA.ic</a>
          </div>
        </section>
        
        <section>
          <p>Latest news: <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=baeb9a7d8b60b021d907127509c44507539c15e5"
               target="_blank">real-time is now supported by mainline Linux kernel</a>.</p>
          <p>&rArr; "standard" Linux now can provide deterministic response time.</p>
        </section>
        
        <!-- -------------------- More about what an RTOS is ---------------------------------------- -->

        <section id="moreAboutRtos">
          <h2>More about what an RTOS is</h2>
        </section>
        
        <section>
            <h3>Problem</h3>
            <p>The bare metal architecture (ISR + background task) seen before does not provide solutions
               to the following needs:</p>
            <ul>
                <li>Structure application code in several "independent" units of execution</li>
                <li>Share data between these units</li>
                <li>Handle different priorities</li>
                <li>Ensure that time constraints are met (or not met)</li>
                <li>Etc.</li>
            </ul>
        </section>
        
        <section>
            <h3>A solution</h3>
            <p>An RTOS.</p>
        </section>
        
        <section>
          <h3>More precisely</h3>
          <p class="pbcenter">RTOS = OS intended for real-time applications.</p>
          <ul>
            <li>Provides minimal latency when handling events</li>
            <li>Guarantees predictable response time</li>
          </ul>
        </section>
        
        <section>
            <h3>Soft and hard real time</h3>
            <ul>
                <li><b>Hard real time</b>: when a system will cease to function if a deadline is missed, 
                    which can result in catastrophic consequences</li>
                <li class="fragment"><b>Soft real time</b>: when a system continues to function even if
                    it’s unable to execute within an allotted time. If the system has missed its deadline,
                    it will not result in critical consequences. The system can continue to function,
                    though with undesirable lower quality of output</li>
            </ul>
            <div class="pbverysmall">Source: <a href="https://www.intel.com/content/www/us/en/robotics/real-time-systems.html" title="Intel" target="_blank">Intel</a></div>
        </section>
        
        <section>
            <p>This presentation is about soft real time only.</p>
        </section>
        
        <!-- -------------------- RTOS benefits ---------------------------------------- -->

        <section id="benefits">
          <h2>Benefits</h2>
        </section>
        
        <section>
          <ul>
            <li>
              Provides a way to split application code in several execution blocks
            </li>
            <li class="fragment">
              Allows to prioritize execution blocks
            </li>
            <li class="fragment">
              Application architecture easier to design: several execution blocks can 
              concurrently process events
            </li>
            <li class="fragment">
              Can reuse existing middleware (TCP/IP stack, flash file system, time handling, etc.)
              more easily
            </li>
            <li class="fragment">
              Provides a common reference framework for teams of several developers
            </li>
            <li class="fragment">
              Makes application code more portable (to different hardware targets)
            </li>
            <li class="fragment">
              ...
            </li>
          </ul>
        </section>
        
        <!-- -------------------- RTOS drawbacks ---------------------------------------- -->

        <section id="drawbacks">
          <h2>Drawbacks</h2>
        </section>
        
        <section>
          <ul>
            <li>
              Requires more flash memory (from a few KB to a few tens of KB)
            </li>
            <li class="fragment">
              Requires more RAM (fixed quantity + quantity depending on execution blocks)
            </li>
            <li class="fragment">
              Consumes some processing power (a few %)
            </li>
            <li class="fragment">
              Associated learning curve must be taken into account
            </li>
            <li class="fragment">
              Brings in a software dependency
            </li>
          </ul>
        </section>
        
        <!-- -------------------- RTOS components ---------------------------------------- -->

        <section id="components">
          <h2>Components</h2>
        </section>
        
        <section>
          <p class="pbcenter">Usual components:</p>
          <ul>
            <li>
              Scheduler - assigns computing resource to the execution blocks <em>(tasks</em> or 
              <em>threads)</em>
            </li>
            <li class="fragment">
              Services allowing concurrent accesses to shared resources
            </li>
            <li class="fragment">
              Communication services letting tasks exchange data
            </li>
            <li class="fragment">
              Time services
            </li>
            <li class="fragment">
              Memory allocation services
            </li>
            <li class="fragment">
              Middleware: Wi-Fi stack, Bluetooth stack, TCP/IP stack, USB stack, flash file system, 
              GUI, etc.
            </li>
          </ul>
          <p class="pbsmaller fragment">GUI: Graphical User Interface</p>
        </section>
        
        <!-- -------------------- RTOS > tasks ---------------------------------------- -->
        
        <section id="tasks">
          <h2>Tasks</h2>
        </section>
        
        <section id="whatATaskIs">
          <p>Task: a long-living execution block.</p>
          <ul>
            <li>The application is made of several tasks.</li>
            <li>These tasks may have to exchange data and to synchronize.</li>
            <li>Each task has its own execution context</li>
            <li>Each task can be assigned a priority</li>
            <li>Each task is assigned a "fair" proportion of processing time by the scheduler</li>
          </ul>
        </section>
        
        <section>
          <p>A task may be in one of several states. Usually:</p>
          <ul>
            <li><b>Ready</b>: the task is ready to run, but another one is using the processor</li>
            <li><b>Running</b>: the task is being executed</li>
            <li><b>Blocked</b> (or <b>Waiting</b>): the task is waiting for an event (timer timeout, reception of
                a byte on a serial link, etc.)</li>
            <li><b>Suspended</b>: the task won't use the processor anymore</li>
          </ul>
        </section>
        
        <section>
          <h3>For FreeRTOS:</h3>
          <img src="images/freeRtosTaskStates.gif">
          <div class="pbverysmall">Source: <a href="https://www.freertos.org/RTOS-task-states.html" 
                                              title="FreeRTOS" target="_blank">FreeRTOS</a></div>
        </section>
        
        <section>
          <h3>For Zephyr OS:</h3>
          <img src="images/zephyrTaskStates.svg">
          <div class="pbverysmall">Source: <a href="https://docs.zephyrproject.org/latest/kernel/services/threads/index.html#thread-states" 
                                              title="Zephyr Project" target="_blank">Zephyr Project</a></div>
        </section>
        
        <section>
          <p>On a microcontroller with one core: only one task can be executed at a given time.</p>
          <p>&rArr; Difference between <em>concurrency</em> and <em>parallelism:</em></p>
          <ul>
            <li><strong>Concurrency</strong>: several tasks appear to be running at the same time</li>
            <li><strong>Parallelism</strong>: several tasks are really running at the same time</li>
          </ul>
        </section>
        
        <section>
          <p>The scheduler is the magic behind concurrency.</p>
          <p>Scheduling method depends on the RTOS.</p>
          <p>For FreeRTOS:</p>
          <ul>
            <li>
              <strong>Fixed priority</strong> - task priority is not changed (excepted for priority inheritance - see farther)
            </li>
            <li class="fragment fade-in">
              <strong>Preemptive</strong> - if a higher priority task enters ready state (due to 
              some event), and a lower priority task is being executed, the scheduler stops it 
              and starts the higher priority one
            </li>
            <li class="fragment fade-in">
              <strong>Round-robin time slicing</strong> - every task in the set of tasks with same priority is
              guaranteed to be executed after some time
            </li>
          </ul>
        </section>
        
        <section>
          <p>When a task requests to wait for some event:</p>
          <ul>
            <li>The task enters the <b>blocked</b> (<b>waiting</b>) state</li>
            <li>The scheduler schedules the task with the highest priority, having waited for the longest 
              time period</li>
          </ul>
        </section>
        
        <section>
          <p>When a task with a given priority loops, for instance polling for an event without 
            waiting for it:</p>
          <ul class="fragment">
            <li>Tasks with lower priority will never be executed.</li>
          </ul>
        </section>
        
        <section>
          <h3>API example</h3>
          <ul>
            <li><code>task_handle_t task_create(...)</code></li>
            <li><code>status_t task_delete(task_handle_t th)</code></li>
            <li><code>status_t task_priority_set(task_handle_t th)</code></li>
            <li><code>status_t task_suspend(task_handle_t th)</code></li>
            <li><code>status_t task_resume(task_handle_t th)</code></li>
            <li><code>...</code></li>
          </ul>
        </section>
        
        <!-- -------------------- Practice: creating and starting one task ---------------------------------------- -->
        
        <section id="exercise11">
          <h3>Exercise 11</h3>
          <p class="pbcenter">Creating and starting one task</p>
        </section>

        <section>
          <ul>
            <li>Purpose: make a LED blink using a task</li>
            <li>What to do: follow the instructions provided by the 
                <a href="https://github.com/PascalBod/RTOS-presentation/blob/main/exercises/11-Start-task/README.md"
                   target="_blank"><code>RTOS-presentation/exercises/11-Start-task/README.md</code></a>
                file</li>
          </ul>
        </section>
        
        <!-- -------------------- Concurrency control ---------------------------------------- -->
        
        <section id="concurrencyControl">
          <h2>Concurrency control</h2>
        </section>

        
        <!-- -------------------- Practice: sharing data bug ---------------------------------------- -->
        
        <section id="exercise12">
          <h3>Exercise 12</h3>
          <p class="pbcenter">Sharing data bug</p>
        </section>

        <section>
          <ul>
            <li>Purpose: exhibit a possible problem when sharing data between tasks</li>
            <li>What to do: follow the instructions provided by the 
                <a href="https://github.com/PascalBod/RTOS-presentation/blob/main/exercises/12-Shared-structure-bug/README.md"
                   target="_blank"><code>RTOS-presentation/exercises/12-Shared-structure-bug/README.md</code></a>
                file</li>
          </ul>
        </section>

	
      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
	  hash: true,
	  slideNumber: 'c/t',
	  // Scroll view inhibited until arrow keys can be used.
	  //view: 'scroll',
	  //scrollProgress: true,
	  // Learn about plugins: https://revealjs.com/plugins/
	  plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
      });
    </script>
  </body>
</html>      
